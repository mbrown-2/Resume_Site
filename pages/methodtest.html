<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <link rel="stylesheet" href="../styles/hw5-styles.css">
        <title>HW5 - Method Test</title>
    </head>
    <body>
        <header>
            <h1>HW5 - Method Test</h1>
            <a href="webcomponent.html" title="Navigate to webcomponent.html">Link to webcomponent.html</a>
            <br /><br />
            <a href="../index.html" title="Back to landing">Back to landing</a>
        </header>

        <main>
            <h2>Requets and Interactivity</h2>
            
            <form action="https://httpbin.org/post" method="post" target="fetch_frame" id="user_form">

                <div id="select_crud">
                    <label for="user_select">Select your CRUD:</label>
                    <select name="user_select" id="user_select" required>
                        <option value="">--</option>
                        <option value="post">POST</option>
                        <option value="get">GET</option>
                        <option value="put">PUT</option>
                        <option value="delete">DELETE</option>
                    </select>
                    <br /><br />
                </div>

                <div id="id">
                    <label for="record_id">Input ID:</label>
                    <input type="text" id="record_id" name="record_id">
                    <br /><br />
                </div>
                
                <div id="name">
                    <label for="article_name">Article name:</label>
                    <input type="text" id="article_name" name="article_name">
                    <br /><br />
                </div>

                <div id="body">
                    <label for="article_body">Article body/content:</label>
                    <textarea id="article_body" name="article_body" rows="3" cols="40" placeholder="Enter here"></textarea>
                    <br /><br />
                </div>

                <div id="time" hidden>
                    <input type="text" id="date" name="date">
                </div>

                <button type="submit" id="submit_button">Post Entry</button>
                
                <br /><br />
                <fieldset id="fieldset">
                    <legend>Server Response</legend>
                    <output id="response">&nbsp;</output>
                    <noscript>
                        <iframe id="fetch_frame" name="fetch_frame"></iframe>
                    </noscript>
                </fieldset>
            </form>

            <br /><hr /><br />

            <script type="module">
                // Scope down selector for future reference
                let divNodes = document.querySelectorAll('#user_form')[0];
                let crudSelector = divNodes[0];                                 // Option CRUD type
                let id = divNodes[1].previousSibling.parentNode
                let name = divNodes[2].previousSibling.parentNode
                let body = divNodes[3].previousSibling.parentNode
                let dateInput = divNodes[4];                                    // For date / time

                console.log(name.getElementsByTagName('label')[0].innerHTML);

                let userForm = document.getElementById('user_form');
                let responseWindow = document.getElementById('response');


                window.addEventListener('DOMContentLoaded', main);
                
                function main() {
                    crudSelector.addEventListener('change', () => alterDisplay(crudSelector.value));

                    userForm.addEventListener('submit', function() {
                        // Create date at time of submitting a query
                        dateInput.value = new Date();
                        makeRequest(event);
                    });
                }

                function alterDisplay(value) {
                    if (value == 'post' || value == '') {
                        id.getElementsByTagName('label')[0].innerHTML = 'Input ID:'
                        name.style.display = 'inline';
                        body.style.display = 'inline';
                    } else if (value == 'get') {
                        id.getElementsByTagName('label')[0].innerHTML = 'ID to retrieve:'
                        name.style.display = 'none';
                        body.style.display = 'none';
                    } else if (value == 'put') {
                        id.getElementsByTagName('label')[0].innerHTML = 'ID to edit:'
                        name.style.display = 'inline';
                        body.style.display = 'inline';
                    } else {
                        id.getElementsByTagName('label')[0].innerHTML = 'ID to delete:'
                        name.style.display = 'none';
                        body.style.display = 'none';
                    }
                }

               

                function makeRequest(event) {
                    event.preventDefault();
                    event.stopPropagation();

                    let payload = new FormData(userForm);
                    let xhr = new XMLHttpRequest();

                    xhr.open(crudSelector.value, 'https://httpbin.org/' + crudSelector.value, true);
                    xhr.onload = () => responseWindow.innerHTML = xhr.responseText;
                    xhr.send(payload);
                }

                // For debugging; provides a path for tracing errors should any occur
                const DEBUG = true;
                const log = (msg) => {if (DEBUG) console.log(msg)}
            </script>
        </main>
    </body>
</html>